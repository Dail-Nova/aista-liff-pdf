<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>文字起こし・要約ツール - アイスタ</title>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>
  <style>
    /* ========================================
       基本スタイル
       ======================================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Yu Gothic UI", sans-serif;
      background: linear-gradient(135deg, #001845 0%, #003366 50%, #0080FF 100%);
      background-attachment: fixed;
      min-height: 100vh;
      padding: 20px;
      padding-bottom: max(20px, env(safe-area-inset-bottom));
      color: #1A202C;
    }

    .container {
      max-width: 500px;
      margin: 40px auto;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 32px 20px 20px 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* ========================================
       Page 0: Loading
       ======================================== */
    .loading-screen {
      text-align: center;
      padding: 40px 20px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #E2E8F0;
      border-top: 3px solid #0284C7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 14px;
      color: #64748B;
    }

    /* ========================================
       Page 1: Login
       ======================================== */
    .login-screen {
      text-align: center;
      padding: 20px;
    }

    .login-title {
      font-size: 24px;
      font-weight: 600;
      color: #1A202C;
      margin-bottom: 16px;
    }

    .login-description {
      font-size: 14px;
      color: #64748B;
      line-height: 1.7;
      margin-bottom: 24px;
    }

    .btn-login {
      background: #06C755;
      color: white;
      padding: 14px 32px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(6, 199, 85, 0.3);
      transition: all 0.2s;
    }

    .btn-login:active {
      transform: scale(0.98);
    }

    .login-hint {
      margin-top: 20px;
      padding: 16px;
      background: #F8FAFC;
      border-radius: 8px;
      font-size: 13px;
      color: #64748B;
    }

    /* ========================================
       Page 2, 3, 4: Main Screen
       ======================================== */
    .main-screen {
      display: none;
    }

    .main-screen.active {
      display: block;
    }

    .header {
      text-align: center;
      margin-bottom: 24px;
    }

    .header-title {
      font-size: 22px;
      font-weight: 600;
      color: #1A202C;
      margin-bottom: 8px;
    }

    .header-subtitle {
      font-size: 14px;
      color: #64748B;
      line-height: 1.7;
    }

    /* File Restrictions */
    .file-restrictions {
      background: #F0F9FF;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
    }

    .restrictions-title {
      font-size: 12px;
      font-weight: 600;
      color: #0284C7;
      margin-bottom: 8px;
    }

    .restrictions-list {
      list-style: none;
      font-size: 12px;
      color: #64748B;
      line-height: 1.6;
    }

    .restrictions-list li {
      padding-left: 12px;
      position: relative;
    }

    .restrictions-list li::before {
      content: '•';
      position: absolute;
      left: 0;
      color: #0284C7;
    }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 12px;
    }

    .btn:last-of-type {
      margin-bottom: 0;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(180deg, #0EA5E9 0%, #0284C7 100%);
      color: white;
      box-shadow: 
        0 2px 4px rgba(2, 132, 199, 0.15),
        0 4px 8px rgba(2, 132, 199, 0.1);
      position: relative;
      overflow: hidden;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.05) 0%, transparent 100%);
      pointer-events: none;
    }

    .btn-primary:active {
      background: linear-gradient(180deg, #0284C7 0%, #0369A1 100%);
      box-shadow: 
        0 1px 2px rgba(2, 132, 199, 0.2),
        inset 0 1px 3px rgba(0, 0, 0, 0.1);
      transform: scale(0.97);
    }

    .btn-upload {
      background: linear-gradient(180deg, #34D399 0%, #10B981 100%);
      color: white;
      box-shadow: 
        0 2px 4px rgba(16, 185, 129, 0.15),
        0 4px 8px rgba(16, 185, 129, 0.1);
      position: relative;
      overflow: hidden;
    }

    .btn-upload::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.05) 0%, transparent 100%);
      pointer-events: none;
    }

    .btn-upload:active {
      background: linear-gradient(180deg, #10B981 0%, #059669 100%);
      box-shadow: 
        0 1px 2px rgba(16, 185, 129, 0.2),
        inset 0 1px 3px rgba(0, 0, 0, 0.1);
      transform: scale(0.97);
    }

    #fileInput {
      display: none;
    }

    /* ========================================
       Page 3: File List
       ======================================== */
    .file-list {
      margin: 20px 0;
      display: none;
    }

    .file-list.active {
      display: block;
    }

    .file-list-header {
      text-align: center;
      padding: 12px;
      background: #F0F9FF;
      border-radius: 8px;
      font-size: 13px;
      color: #0284C7;
      margin-bottom: 12px;
      font-weight: 500;
    }

    .file-item {
      background: #F8FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .file-info {
      flex: 1;
      min-width: 0;
    }

    .file-name {
      font-weight: 500;
      font-size: 14px;
      color: #1A202C;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-size {
      font-size: 12px;
      color: #94A3B8;
    }

    .file-remove {
      background: linear-gradient(180deg, #F87171 0%, #EF4444 100%);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 12px;
      flex-shrink: 0;
      box-shadow: 
        0 2px 4px rgba(239, 68, 68, 0.15),
        0 4px 8px rgba(239, 68, 68, 0.1);
      position: relative;
      overflow: hidden;
      transition: all 0.2s;
    }

    .file-remove::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.05) 0%, transparent 100%);
      pointer-events: none;
    }

    .file-remove:active {
      background: linear-gradient(180deg, #EF4444 0%, #DC2626 100%);
      box-shadow: 
        0 1px 2px rgba(239, 68, 68, 0.2),
        inset 0 1px 3px rgba(0, 0, 0, 0.1);
      transform: scale(0.95);
    }

    /* ========================================
       Page 4: Progress (3つの光るドット)
       ======================================== */
    .progress-container {
      margin: 24px 0 0 0;
      display: none;
    }

    .progress-container.active {
      display: block;
    }

    .loading-dots {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .dot {
      width: 10px;
      height: 10px;
      background: #0284C7;
      border-radius: 50%;
      animation: pulse-dot 1.2s ease-in-out infinite;
    }

    .dot:nth-child(1) {
      animation-delay: 0s;
    }

    .dot:nth-child(2) {
      animation-delay: 0.3s;
    }

    .dot:nth-child(3) {
      animation-delay: 0.6s;
    }

    @keyframes pulse-dot {
      0%, 100% {
        transform: scale(0.6);
        opacity: 0.3;
        box-shadow: 0 0 0 rgba(2, 132, 199, 0);
      }
      50% {
        transform: scale(1.4);
        opacity: 1;
        box-shadow: 0 0 20px rgba(2, 132, 199, 0.6),
                    0 0 40px rgba(2, 132, 199, 0.3);
      }
    }

    .progress-text {
      text-align: center;
      font-size: 13px;
      color: #64748B;
    }

    /* ========================================
       Progress Notice（10秒後表示）
       ======================================== */
    .progress-notice {
      margin-top: 24px;
      text-align: center;
      animation: fadeIn 0.5s ease;
    }

    .notice-text {
      font-size: 14px;
      color: #64748B;
      line-height: 1.7;
      margin-bottom: 20px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ========================================
       Page 5: Complete (Apple式デザイン)
       ======================================== */
    .complete-screen {
      text-align: center;
      padding: 0;
      margin: -8px 0 0 0;
      display: none;
    }

    .complete-screen.active {
      display: block;
    }

    .complete-title {
      font-size: 28px;
      font-weight: 700;
      color: #0C4A6E;
      letter-spacing: 0.02em;
      margin-bottom: 7px;
    }

    .complete-divider {
      width: 180px;
      height: 1px;
      background: #CBD5E0;
      margin: 0 auto 20px;
    }

    .complete-message {
      font-size: 16px;
      font-weight: 500;
      color: #1A202C;
      line-height: 1.8;
      margin-bottom: 16px;
    }

    .btn-line {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #06C755;
      color: white;
      width: 100%;
      padding: 16px 20px;
      border: none;
      border-radius: 12px;
      font-size: 19px;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: -0.01em;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-line:active {
      background: #05A043;
      transform: scale(0.95);
    }

    .btn-line.shrink-out {
      transform: scale(0);
      opacity: 0;
    }

    @media (hover: hover) and (pointer: fine) {
      .btn-line {
        box-shadow: 
          0 1px 3px rgba(0, 0, 0, 0.12),
          0 1px 2px rgba(0, 0, 0, 0.08);
      }

      .btn-line:hover {
        background: #05B34B;
        box-shadow: 
          0 4px 6px rgba(0, 0, 0, 0.1),
          0 2px 4px rgba(0, 0, 0, 0.06);
        transform: translateY(-1px);
      }

      .btn-line:active {
        background: #05A043;
        box-shadow: 
          0 1px 2px rgba(0, 0, 0, 0.12);
        transform: translateY(0);
      }
    }

    /* ========================================
       Error Display
       ======================================== */
    .error-screen {
      text-align: center;
      padding: 20px;
      display: none;
    }

    .error-screen.active {
      display: block;
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .error-title {
      font-size: 20px;
      font-weight: 600;
      color: #EF4444;
      margin-bottom: 12px;
    }

    .error-message {
      font-size: 14px;
      color: #64748B;
      line-height: 1.7;
      margin-bottom: 24px;
    }

    .error-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* ========================================
       Toast Notification
       ======================================== */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #1A202C;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: none;
      animation: slideDown 0.3s ease;
      min-width: 280px;
      max-width: 90%;
      text-align: center;
      white-space: nowrap;
    }

    .toast.active {
      display: block;
    }

    .toast.error {
      background: #EF4444;
    }

    .toast.warning {
      background: #F59E0B;
    }

    .toast.success {
      background: #10B981;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* ========================================
       Responsive
       ======================================== */
    @media (min-width: 480px) {
      .card {
        padding: 40px 32px 24px 32px;
      }
      
      .header-title {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>

  <div class="container">
    <div class="card" id="app">
      <!-- Page 0: Loading -->
      <div class="loading-screen" id="page-loading">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading...</p>
      </div>

      <!-- Page 1: Login -->
      <div class="login-screen" id="page-login" style="display:none;">
        <h2 class="login-title">LINEでログイン</h2>
        <p class="login-description">
          このサービスを利用するには<br>
          LINEアカウントでのログインが必要です
        </p>
        <button class="btn-login" onclick="doLogin()">LINEでログイン</button>
        <div class="login-hint" id="login-hint" style="display:none;">
          <p>QRコードまたはメール/パスワードでログイン可能です</p>
        </div>
      </div>

      <!-- Page 2, 3, 4: Main Screen -->
      <div class="main-screen" id="page-main">
        <div class="header">
          <h2 class="header-title">文字起こし・要約ツール</h2>
          <p class="header-subtitle">
            教科書やプリントを<br>
            簡単にテキスト化できます
          </p>
        </div>

        <!-- File Restrictions -->
        <div class="file-restrictions">
          <p class="restrictions-title">ファイル制限</p>
          <ul class="restrictions-list">
            <li>最大5件まで同時アップロード可能</li>
            <li>1ファイルあたり10MB以下</li>
            <li>画像・PDFファイル対応</li>
          </ul>
        </div>

        <input type="file" id="fileInput" accept="application/pdf,image/jpeg,image/jpg,image/png,image/heic,image/webp,image/*" multiple>
        
        <button class="btn btn-primary" id="selectBtn">
          ファイルを選択
        </button>

        <!-- Page 3: File List -->
        <div class="file-list" id="fileList"></div>

        <button class="btn btn-upload" id="uploadBtn" style="display:none;">
          アップロードする
        </button>

        <!-- Page 4: Progress -->
        <div class="progress-container" id="progressContainer">
          <div class="loading-dots">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </div>
          <p class="progress-text" id="progressText">変換中...</p>
          
          <!-- 10秒後に表示される通知 -->
          <div class="progress-notice" id="progressNotice" style="display:none;">
            <p class="notice-text">
              処理に時間がかかっています<br><br>
              結果はLINEで通知されます
            </p>
            <button class="btn btn-line" onclick="returnToLine()">
              LINEに戻る
            </button>
          </div>
        </div>
      </div>

      <!-- Page 5: Complete -->
      <div class="complete-screen" id="page-complete">
        <h3 class="complete-title">完了しました!</h3>
        <div class="complete-divider"></div>
        <p class="complete-message">
          LINEで結果をお届けしています。<br><br>
          今すぐトーク画面を<br>
          チェックしてみましょう！
        </p>
        <button class="btn btn-line" id="btnCloseLiff" style="display:none;" onclick="closeLiffWindow()">
          LINEに戻る
        </button>
      </div>

      <!-- Error Screen -->
      <div class="error-screen" id="page-error">
        <div class="error-icon">⚠️</div>
        <h3 class="error-title" id="errorTitle">エラー</h3>
        <p class="error-message" id="errorMessage"></p>
        <div class="error-actions" id="errorActions"></div>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // 設定値
    // ========================================
    const LIFF_ID = '2008235357-glQqmdnP';
    const WORKER_URL = 'https://aista-pdf-processor.luminalice-reg-tea-sun-red-9b0.workers.dev/upload-pdf';
    const DEBUG_MODE = false;
    const MAX_FILE_SIZE = 10 * 1024 * 1024;
    const MAX_FILES = 5;

    let currentUserId = null;
    let currentDisplayName = null;
    let selectedFiles = [];
    let uploadStartTime = null;
    let progressNoticeTimer = null;

    // ========================================
    // エラータイプ定義
    // ========================================
    const ErrorType = {
      LIFF_SDK_LOAD_FAILED: 'LIFF_SDK_LOAD_FAILED',
      LIFF_INIT_FAILED: 'LIFF_INIT_FAILED',
      PROFILE_FETCH_FAILED: 'PROFILE_FETCH_FAILED',
      FILE_TYPE_INVALID: 'FILE_TYPE_INVALID',
      FILE_SIZE_EXCEEDED: 'FILE_SIZE_EXCEEDED',
      FILE_COUNT_EXCEEDED: 'FILE_COUNT_EXCEEDED',
      FILE_DUPLICATE: 'FILE_DUPLICATE',
      FILE_READ_FAILED: 'FILE_READ_FAILED',
      BASE64_CONVERSION_FAILED: 'BASE64_CONVERSION_FAILED',
      NETWORK_ERROR: 'NETWORK_ERROR',
      SERVER_ERROR_4XX: 'SERVER_ERROR_4XX',
      SERVER_ERROR_5XX: 'SERVER_ERROR_5XX',
      RESPONSE_PARSE_FAILED: 'RESPONSE_PARSE_FAILED',
      CLOSE_WINDOW_FAILED: 'CLOSE_WINDOW_FAILED',
      LOGIN_FAILED: 'LOGIN_FAILED',
      UNKNOWN_ERROR: 'UNKNOWN_ERROR'
    };

    // ========================================
    // エラーメッセージ定義
    // ========================================
    const ErrorMessages = {
      [ErrorType.LIFF_SDK_LOAD_FAILED]: {
        title: 'LIFF SDKの読み込みに失敗',
        message: 'ページを再読み込みしてください',
        action: 'reload',
        retryable: true,
        toast: false
      },
      [ErrorType.LIFF_INIT_FAILED]: {
        title: 'LINEとの接続に失敗',
        message: 'しばらく待ってから再度お試しください',
        action: 'retry',
        retryable: true,
        toast: false
      },
      [ErrorType.PROFILE_FETCH_FAILED]: {
        title: 'ユーザー情報の取得に失敗',
        message: '再度ログインしてください',
        action: 'relogin',
        retryable: true,
        toast: false
      },
      [ErrorType.FILE_TYPE_INVALID]: {
        title: 'ファイル形式エラー',
        message: 'PDF・画像ファイルのみアップロード可能です',
        action: 'continue',
        retryable: false,
        toast: true
      },
      [ErrorType.FILE_SIZE_EXCEEDED]: {
        title: 'ファイルサイズ超過',
        message: 'ファイルサイズは10MB以下にしてください',
        action: 'continue',
        retryable: false,
        toast: true
      },
      [ErrorType.FILE_COUNT_EXCEEDED]: {
        title: 'ファイル数超過',
        message: '一度にアップロードできるのは5ファイルまでです',
        action: 'continue',
        retryable: false,
        toast: true
      },
      [ErrorType.FILE_DUPLICATE]: {
        title: '重複ファイル',
        message: '同じファイルが既に選択されています',
        action: 'continue',
        retryable: false,
        toast: true
      },
      [ErrorType.FILE_READ_FAILED]: {
        title: 'ファイル読み込みエラー',
        message: 'ファイルが破損しているか、アクセスできません',
        action: 'cancel',
        retryable: false,
        toast: false
      },
      [ErrorType.BASE64_CONVERSION_FAILED]: {
        title: 'ファイル変換エラー',
        message: 'ファイルの変換に失敗しました',
        action: 'cancel',
        retryable: false,
        toast: false
      },
      [ErrorType.NETWORK_ERROR]: {
        title: 'ネットワークエラー',
        message: 'インターネット接続を確認してください',
        action: 'retry',
        retryable: true,
        toast: false
      },
      [ErrorType.SERVER_ERROR_4XX]: {
        title: 'リクエストエラー',
        message: 'データの送信に失敗しました',
        action: 'cancel',
        retryable: false,
        toast: false
      },
      [ErrorType.SERVER_ERROR_5XX]: {
        title: 'サーバーエラー',
        message: 'サーバーで問題が発生しています。しばらく待ってから再度お試しください',
        action: 'retry',
        retryable: true,
        toast: false
      },
      [ErrorType.RESPONSE_PARSE_FAILED]: {
        title: 'レスポンス解析エラー',
        message: 'サーバーからの応答が不正です',
        action: 'cancel',
        retryable: false,
        toast: false
      },
      [ErrorType.CLOSE_WINDOW_FAILED]: {
        title: '画面を閉じられません',
        message: '画面左上の「×」ボタンで閉じてください',
        action: 'manual',
        retryable: false,
        toast: true
      },
      [ErrorType.LOGIN_FAILED]: {
        title: 'ログインに失敗',
        message: '再度ログインボタンを押してください',
        action: 'relogin',
        retryable: true,
        toast: false
      },
      [ErrorType.UNKNOWN_ERROR]: {
        title: '予期しないエラー',
        message: 'エラーが発生しました。ページを再読み込みしてください',
        action: 'reload',
        retryable: true,
        toast: false
      }
    };

    // ========================================
    // エラーハンドラークラス
    // ========================================
    class ErrorHandler {
      constructor() {
        this.retryCount = {};
        this.maxRetries = 3;
      }

      handle(errorType, context = {}) {
        const errorConfig = ErrorMessages[errorType] || ErrorMessages[ErrorType.UNKNOWN_ERROR];
        
        console.error(`[${errorType}]`, context);

        if (errorConfig.toast) {
          this.showToast(errorConfig.message, 'error');
        } else {
          this.showErrorUI(errorConfig, errorType, context);
        }
      }

      showToast(message, type = 'error') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type} active`;
        
        setTimeout(() => {
          toast.classList.remove('active');
        }, 3000);
      }

      showErrorUI(config, errorType, context) {
        const errorTitle = document.getElementById('errorTitle');
        const errorMessage = document.getElementById('errorMessage');
        const errorActions = document.getElementById('errorActions');
        
        errorTitle.textContent = config.title;
        errorMessage.textContent = config.message;
        
        errorActions.innerHTML = '';
        
        if (config.action === 'retry' && config.retryable) {
          const retryBtn = document.createElement('button');
          retryBtn.className = 'btn btn-primary';
          retryBtn.textContent = '再試行';
          retryBtn.onclick = () => this.retry(errorType);
          errorActions.appendChild(retryBtn);
        }
        
        if (config.action === 'reload') {
          const reloadBtn = document.createElement('button');
          reloadBtn.className = 'btn btn-primary';
          reloadBtn.textContent = 'ページを再読み込み';
          reloadBtn.onclick = () => location.reload();
          errorActions.appendChild(reloadBtn);
        }
        
        if (config.action === 'relogin') {
          const loginBtn = document.createElement('button');
          loginBtn.className = 'btn btn-primary';
          loginBtn.textContent = '再ログイン';
          loginBtn.onclick = doLogin;
          errorActions.appendChild(loginBtn);
        }
        
        if (config.action === 'cancel' || config.action === 'continue' || config.action === 'manual') {
          const backBtn = document.createElement('button');
          backBtn.className = 'btn btn-primary';
          backBtn.textContent = '戻る';
          backBtn.onclick = () => {
            this.resetUploadState();
            showPage('page-main');
          };
          errorActions.appendChild(backBtn);
        }
        
        showPage('page-error');
      }

      retry(errorType) {
        if (!this.retryCount[errorType]) {
          this.retryCount[errorType] = 0;
        }
        
        this.retryCount[errorType]++;
        
        if (this.retryCount[errorType] >= this.maxRetries) {
          this.showToast('再試行回数が上限に達しました。ページを再読み込みしてください。', 'error');
          return;
        }
        
        switch (errorType) {
          case ErrorType.LIFF_INIT_FAILED:
            location.reload();
            break;
          case ErrorType.NETWORK_ERROR:
          case ErrorType.SERVER_ERROR_5XX:
            showPage('page-main');
            uploadFiles();
            break;
          default:
            showPage('page-main');
        }
      }

      resetUploadState() {
        const selectBtn = document.getElementById('selectBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressNotice = document.getElementById('progressNotice');
        
        if (selectBtn) selectBtn.disabled = false;
        if (uploadBtn) uploadBtn.disabled = false;
        if (progressContainer) progressContainer.classList.remove('active');
        
        // 通知を非表示にする
        if (progressNotice) progressNotice.style.display = 'none';
        
        // タイマークリア
        if (progressNoticeTimer) {
          clearTimeout(progressNoticeTimer);
          progressNoticeTimer = null;
        }
      }
    }

    const errorHandler = new ErrorHandler();

    // ========================================
    // ページ切り替え
    // ========================================
    function showPage(pageName) {
      const pages = ['page-loading', 'page-login', 'page-main', 'page-complete', 'page-error'];
      pages.forEach(page => {
        const element = document.getElementById(page);
        if (element) {
          element.style.display = 'none';
          element.classList.remove('active');
        }
      });
      
      const targetPage = document.getElementById(pageName);
      if (targetPage) {
        targetPage.style.display = 'block';
        targetPage.classList.add('active');
      }
    }

    // ========================================
    // デバイス判定
    // ========================================
    function isPC() {
      const ua = navigator.userAgent;
      return !/iPhone|iPad|iPod|Android/i.test(ua);
    }

    // ========================================
    // LIFF初期化（高速化版）
    // ========================================
    window.addEventListener('DOMContentLoaded', function() {
      console.log('DOMContentLoaded');
      
      showPage('page-loading');
      
      if (typeof liff === 'undefined') {
        errorHandler.handle(ErrorType.LIFF_SDK_LOAD_FAILED);
        return;
      }

      // タイムアウト付きLIFF初期化
      Promise.race([
        liff.init({ 
          liffId: LIFF_ID,
          withLoginOnExternalBrowser: true
        }),
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error('LIFF init timeout')), 5000)
        )
      ])
      .then(() => {
        console.log('LIFF初期化成功');
        
        if (!liff.isLoggedIn()) {
          console.log('未ログイン → ログイン画面表示');
          showPage('page-login');
          
          if (isPC()) {
            document.getElementById('login-hint').style.display = 'block';
          }
          return;
        }

        console.log('ログイン済み → プロフィール取得');
        return liff.getProfile();
      })
      .then((profile) => {
        if (!profile) return;
        
        currentUserId = profile.userId;
        currentDisplayName = profile.displayName;
        
        console.log('User ID:', currentUserId);
        
        showMainScreen();
      })
      .catch((err) => {
        console.error('LIFF初期化エラー:', err);
        
        if (err.message && err.message.includes('profile')) {
          errorHandler.handle(ErrorType.PROFILE_FETCH_FAILED, { error: err });
        } else {
          errorHandler.handle(ErrorType.LIFF_INIT_FAILED, { error: err, liffId: LIFF_ID });
        }
      });
    });

    // ========================================
    // ログイン処理
    // ========================================
    function doLogin() {
      console.log('ログイン実行');
      try {
        liff.login();
      } catch (error) {
        console.error('ログインエラー:', error);
        errorHandler.handle(ErrorType.LOGIN_FAILED, { error });
      }
    }

    // ========================================
    // メイン画面表示
    // ========================================
    function showMainScreen() {
      showPage('page-main');
      
      document.getElementById('selectBtn').addEventListener('click', selectFile);
      document.getElementById('fileInput').addEventListener('change', handleFileSelect);
      document.getElementById('uploadBtn').addEventListener('click', uploadFiles);
      
      console.log('メイン画面表示完了');
    }

    // ========================================
    // ファイル選択
    // ========================================
    function selectFile() {
      console.log('ファイル選択ダイアログ起動');
      document.getElementById('fileInput').click();
    }

    function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      console.log(`${files.length}個のファイルが選択されました`);

      if (selectedFiles.length + files.length > MAX_FILES) {
        errorHandler.handle(ErrorType.FILE_COUNT_EXCEEDED, {
          current: selectedFiles.length,
          adding: files.length,
          max: MAX_FILES
        });
        event.target.value = '';
        return;
      }

      let addedCount = 0;

      // 許可するファイル形式
      const allowedTypes = [
        'application/pdf',
        'image/jpeg',
        'image/jpg',
        'image/png',
        'image/heic',
        'image/webp'
      ];

      for (const file of files) {
        if (!allowedTypes.includes(file.type)) {
          errorHandler.handle(ErrorType.FILE_TYPE_INVALID, {
            fileName: file.name,
            fileType: file.type
          });
          continue;
        }

        if (file.size > MAX_FILE_SIZE) {
          errorHandler.handle(ErrorType.FILE_SIZE_EXCEEDED, {
            fileName: file.name,
            fileSize: file.size,
            maxSize: MAX_FILE_SIZE
          });
          continue;
        }

        if (selectedFiles.some(f => f.name === file.name)) {
          errorHandler.handle(ErrorType.FILE_DUPLICATE, {
            fileName: file.name
          });
          continue;
        }

        selectedFiles.push(file);
        addedCount++;
        console.log(`追加: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
      }

      if (addedCount > 0) {
        errorHandler.showToast(`${addedCount}件のファイルを追加しました`, 'success');
      }

      updateFileList();
      event.target.value = '';
    }

    // ========================================
    // HTMLエスケープ関数（XSS対策）
    // ========================================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========================================
    // ファイルリスト更新
    // ========================================
    function updateFileList() {
      const fileListDiv = document.getElementById('fileList');
      const uploadBtn = document.getElementById('uploadBtn');

      if (selectedFiles.length === 0) {
        fileListDiv.classList.remove('active');
        uploadBtn.style.display = 'none';
        return;
      }

      fileListDiv.classList.add('active');
      uploadBtn.style.display = 'block';

      const totalSize = selectedFiles.reduce((sum, f) => sum + f.size, 0);
      
      fileListDiv.innerHTML = `
        <div class="file-list-header">
          選択中のファイル (${selectedFiles.length}/${MAX_FILES}件) - ${(totalSize / 1024 / 1024).toFixed(2)} MB
        </div>
        ${selectedFiles.map((file, index) => `
          <div class="file-item">
            <div class="file-info">
              <div class="file-name">${escapeHtml(file.name)}</div>
              <div class="file-size">${(file.size / 1024).toFixed(2)} KB</div>
            </div>
            <button class="file-remove" onclick="removeFile(${index})">削除</button>
          </div>
        `).join('')}
      `;
    }

    function removeFile(index) {
      const fileName = selectedFiles[index].name;
      selectedFiles.splice(index, 1);
      console.log(`削除: ${fileName}`);
      errorHandler.showToast(`${fileName} を削除しました`, 'warning');
      updateFileList();
    }

    // ========================================
    // アップロード処理
    // ========================================
    async function uploadFiles() {
      if (selectedFiles.length === 0) {
        errorHandler.showToast('ファイルが選択されていません', 'warning');
        return;
      }

      console.log(`アップロード開始: ${selectedFiles.length}ファイル`);
      
      document.getElementById('selectBtn').disabled = true;
      document.getElementById('uploadBtn').disabled = true;
      
      const progressContainer = document.getElementById('progressContainer');
      progressContainer.classList.add('active');
      
      showProgress('ファイルを準備中...');

      // タイマー開始（10秒後に通知表示）
      uploadStartTime = Date.now();
      progressNoticeTimer = setTimeout(() => {
        showProgressNotice();
      }, 10000); // 10秒

      try {
        const filesData = [];
        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          showProgress(`変換中... (${i + 1}/${selectedFiles.length})`);
          
          try {
            const base64 = await fileToBase64(file);
            filesData.push({
              fileName: file.name,
              fileData: base64,
              fileSize: file.size
            });
            console.log(`Base64変換完了: ${file.name}`);
          } catch (conversionError) {
            errorHandler.handle(ErrorType.BASE64_CONVERSION_FAILED, {
              fileName: file.name,
              error: conversionError
            });
            throw conversionError;
          }
        }

        showProgress('サーバーに送信中...');
        console.log('Workersに送信...');

        const response = await fetch(WORKER_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: currentUserId,
            displayName: currentDisplayName,
            files: filesData
          })
        });

        showProgress('レスポンス受信中...');
        console.log('レスポンス受信:', response.status);

        if (response.status >= 400 && response.status < 500) {
          const errorData = await response.text();
          errorHandler.handle(ErrorType.SERVER_ERROR_4XX, {
            status: response.status,
            data: errorData
          });
          return;
        }

        if (response.status >= 500) {
          const errorData = await response.text();
          errorHandler.handle(ErrorType.SERVER_ERROR_5XX, {
            status: response.status,
            data: errorData
          });
          return;
        }

        let result;
        try {
          result = await response.json();
        } catch (parseError) {
          const responseText = await response.text();
          errorHandler.handle(ErrorType.RESPONSE_PARSE_FAILED, {
            error: parseError,
            response: responseText
          });
          return;
        }

        console.log('アップロード成功:', result);
        
        // 成功時: タイマーをクリア
        clearTimeout(progressNoticeTimer);
        
        showProgress('完了');
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        showCompletePage();

      } catch (error) {
        console.error('エラー:', error);
        
        // エラー時: タイマーをクリア
        clearTimeout(progressNoticeTimer);
        
        if (error instanceof TypeError && error.message.includes('fetch')) {
          errorHandler.handle(ErrorType.NETWORK_ERROR, { error });
        } else if (error.name !== 'BASE64_CONVERSION_FAILED') {
          errorHandler.handle(ErrorType.UNKNOWN_ERROR, { error });
        }
        
        errorHandler.resetUploadState();
      }
    }

    function showProgress(message) {
      const progressText = document.getElementById('progressText');
      
      if (progressText) progressText.textContent = message || '変換中...';
      
      console.log(`Progress: ${message}`);
    }

    // ========================================
    // 10秒後の通知表示
    // ========================================
    function showProgressNotice() {
      const notice = document.getElementById('progressNotice');
      if (notice) {
        notice.style.display = 'block';
        console.log('進捗通知を表示（10秒経過）');
      }
    }

    // ========================================
    // 処理中にLINEに戻る
    // ========================================
    function returnToLine() {
      console.log('処理中にLINEに戻る');
      
      // タイマークリア
      if (progressNoticeTimer) {
        clearTimeout(progressNoticeTimer);
      }
      
      const btn = event.target;
      btn.classList.add('shrink-out');
      
      setTimeout(() => {
        if (liff.isInClient()) {
          try {
            liff.closeWindow();
            console.log('closeWindow() 実行成功');
          } catch (error) {
            console.error('closeWindow() エラー:', error);
            btn.classList.remove('shrink-out');
            errorHandler.handle(ErrorType.CLOSE_WINDOW_FAILED, { error });
          }
        } else {
          console.log('外部ブラウザ → LINEアプリを起動');
          const lineAppUrl = 'https://line.me/R/';
          window.location.href = lineAppUrl;
        }
      }, 300);
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        
        reader.onerror = (error) => {
          console.error('FileReader Error:', error);
          reject(error);
        };
        
        reader.readAsDataURL(file);
      });
    }

    // ========================================
    // 完了画面表示
    // ========================================
    function showCompletePage() {
      console.log('完了画面表示');
      showPage('page-complete');
      
      const btnCloseLiff = document.getElementById('btnCloseLiff');
      btnCloseLiff.style.display = 'flex';
    }

    function closeLiffWindow() {
      console.log('LINEに戻る');
      
      const btn = document.getElementById('btnCloseLiff');
      
      // 縮小アニメーション開始
      btn.classList.add('shrink-out');
      
      // 300ms後に処理実行
      setTimeout(() => {
        if (liff.isInClient()) {
          // LINEアプリ内: ウィンドウを閉じる
          try {
            liff.closeWindow();
            console.log('closeWindow() 実行成功');
          } catch (error) {
            console.error('closeWindow() エラー:', error);
            btn.classList.remove('shrink-out');
            errorHandler.handle(ErrorType.CLOSE_WINDOW_FAILED, { error });
          }
        } else {
          // ブラウザ: LINEアプリを開く
          console.log('外部ブラウザ → LINEアプリを起動');
          const lineAppUrl = 'https://line.me/R/';
          window.location.href = lineAppUrl;
          
          // 2秒後にToastで案内
          setTimeout(() => {
            errorHandler.showToast('LINEアプリで結果を確認してください', 'success');
          }, 2000);
        }
      }, 300);
    }
  </script>
</body>
</html>
